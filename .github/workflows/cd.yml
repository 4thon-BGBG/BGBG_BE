name: CD (Simple Direct Deployment)

on:
  push:
    branches: [ main ] 

jobs:
  deploy:
    runs-on: self-hosted 
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Deploy and Restart Application (via SSH)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          port: 22
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -euo pipefail
            
            # 1. 프로젝트 디렉토리로 이동
            cd /home/ubuntu/.ssh/BGBG_BE
            source ~/.bashrc
            
            # 2. 최신 코드 pull
            git pull origin main
            
            # 3. 이전 프로세스 종료 
            JAR_NAME=$(ls build/libs/*.jar | head -n 1)
            echo "Stopping old process..."
            pkill -f $JAR_NAME || true
            
            # 4. 실행 권한 부여 및 빌드
            chmod +x gradlew
            ./gradlew clean bootjar -x test --no-daemon
            
            # 5. 백그라운드에서 새로운 JAR 실행 (nohup)
            echo "Starting new JAR: $JAR_NAME"
            nohup java -jar $JAR_NAME \
              --spring.profiles.active=prod \
              > app.log 2>&1 &
              
            echo "Deployment finished. Application restarted in the background."
